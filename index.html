<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Database</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (to compile JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Custom scrollbar for raw JSON view */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans antialiased selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- ICONS (Inlined SVGs to avoid dependency management) ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const ChevronDown = (props) => <Icon {...props} path={<path d="m6 9 6 6 6-6"/>} />;
        const ChevronUp = (props) => <Icon {...props} path={<path d="m18 15-6-6-6 6"/>} />;
        const Activity = (props) => <Icon {...props} path={<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>} />;
        const Sword = (props) => <Icon {...props} path={<><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></>} />;
        const Shield = (props) => <Icon {...props} path={<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>} />;
        const Zap = (props) => <Icon {...props} path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>} />;
        const Box = (props) => <Icon {...props} path={<path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/>} />;
        const Search = (props) => <Icon {...props} path={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />;
        const Filter = (props) => <Icon {...props} path={<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>} />;
        const X = (props) => <Icon {...props} path={<path d="M18 6 6 18M6 6l12 12"/>} />;
        const ArrowUp = (props) => <Icon {...props} path={<path d="m5 12 7-7 7 7M12 19V5"/>} />;
        const ArrowDown = (props) => <Icon {...props} path={<path d="M12 5v14M19 12l-7 7-7-7"/>} />;
        const ArrowUpDown = (props) => <Icon {...props} path={<path d="m7 15 5 5 5-5M7 9l5-5 5 5"/>} />;

        // --- COMPONENTS ---

        const Badge = ({ children, color }) => {
            const colors = {
                red: "bg-red-900/30 text-red-200 border-red-700",
                blue: "bg-blue-900/30 text-blue-200 border-blue-700",
                purple: "bg-purple-900/30 text-purple-200 border-purple-700",
                gray: "bg-slate-700 text-slate-200 border-slate-600",
            };
            return (
                <span className={`px-2 py-1 rounded border text-xs font-bold uppercase tracking-wider ${colors[color] || colors.gray}`}>
                {children}
                </span>
            );
        };

        const SectionHeader = ({ icon: Icon, title }) => (
            <div className="flex items-center gap-2 mb-3 pb-2 border-b border-slate-700 text-slate-200 font-semibold">
                <Icon size={18} className="text-indigo-400" />
                <h3>{title}</h3>
            </div>
        );

        const SortableHeader = ({ label, sortKey, currentSort, onSort }) => {
            const isSorted = currentSort.key === sortKey;
            return (
                <th 
                className="p-4 font-semibold cursor-pointer hover:bg-slate-800 transition-colors select-none group whitespace-nowrap"
                onClick={() => onSort(sortKey)}
                >
                <div className="flex items-center gap-2">
                    {label}
                    <div className="text-slate-500">
                    {isSorted ? (
                        currentSort.direction === 'asc' ? <ArrowUp size={14} className="text-indigo-400" /> : <ArrowDown size={14} className="text-indigo-400" />
                    ) : (
                        <ArrowUpDown size={14} className="opacity-0 group-hover:opacity-50 transition-opacity" />
                    )}
                    </div>
                </div>
                </th>
            );
        };

        const DetailRow = ({ data }) => {
            const [activeTab, setActiveTab] = useState('formatted');

            return (
                <div className="bg-slate-900/50 p-6 rounded-b-lg border-x border-b border-slate-700 shadow-inner animate-in fade-in slide-in-from-top-2 duration-200">
                
                {/* Tabs */}
                <div className="flex gap-4 mb-6 text-sm border-b border-slate-700">
                    <button 
                    onClick={() => setActiveTab('formatted')}
                    className={`pb-2 px-1 transition-colors ${activeTab === 'formatted' ? 'text-indigo-400 border-b-2 border-indigo-400 font-medium' : 'text-slate-400 hover:text-slate-200'}`}
                    >
                    Visual Overview
                    </button>
                    <button 
                    onClick={() => setActiveTab('json')}
                    className={`pb-2 px-1 transition-colors ${activeTab === 'json' ? 'text-indigo-400 border-b-2 border-indigo-400 font-medium' : 'text-slate-400 hover:text-slate-200'}`}
                    >
                    Raw JSON
                    </button>
                </div>

                {activeTab === 'json' ? (
                    <pre className="bg-black/50 p-4 rounded text-xs text-green-400 font-mono overflow-auto max-h-[500px] border border-slate-800">
                    {JSON.stringify(data, null, 2)}
                    </pre>
                ) : (
                    <div className="space-y-8">
                    
                    {/* Header Info with Image */}
                    <div className="flex items-center gap-6 mb-6">
                        <img 
                        src={`https://raw.githubusercontent.com/DZ-David/Morimens/refs/heads/master/images/awakeners/${data.name}.png`}
                        alt={data.name} 
                        className="w-24 h-24 rounded-lg border-2 border-indigo-500/30 object-cover shadow-lg bg-slate-800"
                        />
                        <div>
                        <h2 className="text-2xl font-bold text-slate-100">{data.name}</h2>
                        <div className="flex gap-2 mt-2">
                            <Badge color={data.faction === "CHAOS" ? "purple" : data.faction === "ORDER" ? "blue" : "red"}>
                                {data.faction}
                            </Badge>
                            <Badge color={data.type === "ATTACK" ? "red" : "blue"}>
                                {data.type}
                            </Badge>
                        </div>
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <section>
                        <SectionHeader icon={Activity} title="Base Statistics" />
                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        {Object.entries(data.stats).map(([key, value]) => (
                            <div key={key} className="bg-slate-800 p-2 rounded border border-slate-700 flex flex-col items-center text-center">
                            <span className="text-xs text-slate-400 uppercase tracking-wide mb-1">{key}</span>
                            <span className="text-sm font-medium text-slate-100 break-all">{value}</span>
                            </div>
                        ))}
                        </div>
                    </section>

                    {/* Cards */}
                    <div className="grid md:grid-cols-2 gap-8">
                        <section>
                        <SectionHeader icon={Sword} title="Cards" />
                        <div className="space-y-3">
                            {data.cards && Object.entries(data.cards).map(([key, value]) => (
                            <div key={key} className="bg-slate-800 p-3 rounded border border-slate-700">
                                <div className="flex items-start gap-3">
                                <div className="bg-indigo-900/50 text-indigo-200 px-2 py-1 rounded text-xs font-bold shrink-0 mt-0.5">
                                    {key}
                                </div>
                                <p className="text-sm text-slate-300 leading-relaxed whitespace-pre-wrap">{value}</p>
                                </div>
                            </div>
                            ))}
                        </div>
                        </section>

                        <div className="space-y-8">
                        {/* Exalt */}
                        <section>
                            <SectionHeader icon={Zap} title="Exalts" />
                            <div className="space-y-3">
                            {data.exalt && Object.entries(data.exalt).map(([key, value]) => (
                                <div key={key} className="bg-slate-800 p-3 rounded border border-slate-700">
                                <div className="flex items-start gap-3">
                                    <div className="bg-amber-900/40 text-amber-200 px-2 py-1 rounded text-xs font-bold shrink-0 mt-0.5 uppercase">
                                    {key.replace('_', ' ')}
                                    </div>
                                    <p className="text-sm text-slate-300 leading-relaxed whitespace-pre-wrap">{value}</p>
                                </div>
                                </div>
                            ))}
                            </div>
                        </section>

                        {/* Talents */}
                        <section>
                            <SectionHeader icon={Box} title="Talents" />
                            <div className="space-y-3">
                            {data.talents && Object.entries(data.talents).map(([key, value]) => (
                                <div key={key} className="bg-slate-800 p-3 rounded border border-slate-700">
                                <div className="flex items-start gap-3">
                                    <div className="bg-teal-900/40 text-teal-200 px-2 py-1 rounded text-xs font-bold shrink-0 mt-0.5">
                                    {key}
                                    </div>
                                    <p className="text-sm text-slate-300 leading-relaxed whitespace-pre-wrap">{value}</p>
                                </div>
                                </div>
                            ))}
                            </div>
                        </section>
                        </div>
                    </div>
                    </div>
                )}
                </div>
            );
        };

        const CharacterRow = ({ char }) => {
            const [isExpanded, setIsExpanded] = useState(false);

            const getFactionColor = (f) => {
                if (f === "CHAOS") return "purple";
                if (f === "ORDER") return "blue";
                if (f === "DESTRUCTION") return "red";
                return "gray";
            };

            const getTypeColor = (t) => {
                if (t === "ATTACK") return "red";
                if (t === "DEFENSE") return "blue";
                return "gray";
            };

            return (
                <React.Fragment>
                <tr 
                    onClick={() => setIsExpanded(!isExpanded)}
                    className={`
                    group cursor-pointer transition-colors border-b border-slate-700
                    ${isExpanded ? 'bg-slate-800' : 'bg-slate-800/40 hover:bg-slate-700/50'}
                    `}
                >
                    <td className="p-4 font-bold text-slate-100 text-lg flex items-center gap-4">
                    {isExpanded ? <ChevronUp size={20} className="text-indigo-400 shrink-0" /> : <ChevronDown size={20} className="text-slate-500 group-hover:text-indigo-400 shrink-0" />}
                    
                    <img 
                        src={`https://raw.githubusercontent.com/DZ-David/Morimens/refs/heads/master/images/awakeners/${char.name}.png`}
                        alt={char.name} 
                        className="w-10 h-10 rounded-full border border-slate-600 object-cover bg-slate-800"
                    />
                    
                    {char.name}
                    </td>
                    <td className="p-4">
                    <Badge color={getFactionColor(char.faction)}>{char.faction}</Badge>
                    </td>
                    <td className="p-4">
                    <Badge color={getTypeColor(char.type)}>{char.type}</Badge>
                    </td>
                    
                    {/* New Stats Columns */}
                    <td className="p-4 text-slate-300 font-mono text-sm whitespace-nowrap">
                    {char.stats?.CON || '-'}
                    </td>
                    <td className="p-4 text-slate-300 font-mono text-sm whitespace-nowrap">
                    {char.stats?.ATK || '-'}
                    </td>
                    <td className="p-4 text-slate-300 font-mono text-sm whitespace-nowrap">
                    {char.stats?.DEF || '-'}
                    </td>
                </tr>
                
                {isExpanded && (
                    <tr>
                    <td colSpan="6" className="p-0 border-b border-slate-700">
                        <DetailRow data={char} />
                    </td>
                    </tr>
                )}
                </React.Fragment>
            );
        };

        function App() {
            // State for data fetching
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const [factionFilter, setFactionFilter] = useState('All');
            const [typeFilter, setTypeFilter] = useState('All');
            const [searchTerm, setSearchTerm] = useState('');
            const [searchScope, setSearchScope] = useState('global');
            
            // Sorting State
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });

            // Fetch data on mount
            useEffect(() => {
                fetch('./awakeners.json')
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load data');
                        return response.json();
                    })
                    .then(jsonData => {
                        setData(jsonData);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            // Extract unique options from data
            const factions = useMemo(() => ['All', ...new Set(data.map(c => c.faction))], [data]);
            const types = useMemo(() => ['All', ...new Set(data.map(c => c.type))], [data]);

            // Create Regex object safely
            const searchRegex = useMemo(() => {
                if (!searchTerm) return null;
                try {
                return new RegExp(searchTerm, 'i');
                } catch (e) {
                return null;
                }
            }, [searchTerm]);

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            const getSortValue = (item, key) => {
                if (key === 'name' || key === 'faction' || key === 'type') {
                return item[key];
                }
                // For stats, parse the number
                if (['CON', 'ATK', 'DEF'].includes(key)) {
                const val = item.stats?.[key] || '0';
                // Attempt to parse float from the start of the string (e.g. "132(1.65)*" -> 132)
                return parseFloat(val) || 0;
                }
                return '';
            };

            const filteredAndSortedData = useMemo(() => {
                // 1. Filter
                let result = data.filter(char => {
                    const matchesFaction = factionFilter === 'All' || char.faction === factionFilter;
                    const matchesType = typeFilter === 'All' || char.type === typeFilter;
                    
                    let matchesSearch = true;
                    if (searchTerm) {
                        if (!searchRegex) {
                            matchesSearch = false;
                        } else {
                            let textToSearch = "";
                            if (searchScope === 'global') {
                                textToSearch = JSON.stringify(char);
                            } else if (searchScope === 'cards') {
                                textToSearch = JSON.stringify(char.cards || {});
                            } else if (searchScope === 'exalt') {
                                textToSearch = JSON.stringify(char.exalt || {});
                            }
                            matchesSearch = searchRegex.test(textToSearch);
                        }
                    }
                    return matchesFaction && matchesType && matchesSearch;
                });

                // 2. Sort
                if (sortConfig.key !== null) {
                result.sort((a, b) => {
                    const aValue = getSortValue(a, sortConfig.key);
                    const bValue = getSortValue(b, sortConfig.key);
                    
                    if (aValue < bValue) {
                    return sortConfig.direction === 'asc' ? -1 : 1;
                    }
                    if (aValue > bValue) {
                    return sortConfig.direction === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
                }

                return result;
            }, [data, factionFilter, typeFilter, searchTerm, searchScope, searchRegex, sortConfig]);

            const clearFilters = () => {
                setFactionFilter('All');
                setTypeFilter('All');
                setSearchTerm('');
                setSearchScope('global');
                setSortConfig({ key: null, direction: 'asc' });
            };

            const isRegexInvalid = searchTerm.length > 0 && !searchRegex;

            if (loading) {
                return (
                    <div className="min-h-screen bg-slate-950 text-slate-200 flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p>Loading database...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen bg-slate-950 text-slate-200 flex items-center justify-center p-4">
                        <div className="bg-red-900/20 border border-red-700 rounded-lg p-6 max-w-md text-center">
                            <h2 className="text-xl font-bold text-red-400 mb-2">Error Loading Data</h2>
                            <p className="text-slate-300 mb-4">{error}</p>
                            <div className="text-sm text-slate-400 bg-slate-900 p-3 rounded text-left">
                                <p className="font-bold mb-1">Common Issue:</p>
                                <p>If you are opening this HTML file directly from your computer (file://), browsers block external file requests for security.</p>
                                <p className="mt-2">Try running a local server in this folder: <code className="bg-slate-800 px-1 py-0.5 rounded">npx serve</code> or <code className="bg-slate-800 px-1 py-0.5 rounded">python3 -m http.server</code></p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-950 text-slate-200 p-4 md:p-8 font-sans">
                <div className="max-w-7xl mx-auto">
                    
                    {/* Header */}
                    <div className="mb-8 flex flex-col gap-6">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                        <h1 className="text-3xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
                            Morimens Awakeners Database
                        </h1>
                        <p className="text-slate-400 mt-1">
                            Select a unit below to view combat specifications.
                        </p>
                        </div>
                        <div className="text-xs text-slate-500 bg-slate-900 py-2 px-4 rounded border border-slate-800">
                        {filteredAndSortedData.length} Records Found
                        </div>
                    </div>

                    {/* Filters Panel */}
                    <div className="bg-slate-900 p-4 rounded-lg border border-slate-800 flex flex-col gap-4">
                        
                        {/* Row 1: Search */}
                        <div className="flex flex-col md:flex-row gap-4">
                        <div className="relative flex-grow">
                            <Search size={16} className={`absolute left-3 top-1/2 -translate-y-1/2 ${isRegexInvalid ? 'text-red-500' : 'text-slate-500'}`} />
                            <input 
                                type="text" 
                                placeholder="Search with Regex (e.g., 'Poison|Bleed')..." 
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className={`w-full bg-slate-800 text-slate-200 text-sm rounded border pl-10 pr-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none placeholder:text-slate-600 ${isRegexInvalid ? 'border-red-500 focus:ring-red-500' : 'border-slate-700'}`}
                            />
                        </div>
                        <div className="relative md:w-64 shrink-0">
                            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs uppercase font-bold tracking-wider pointer-events-none">
                                Scope:
                            </div>
                            <select 
                                value={searchScope}
                                onChange={(e) => setSearchScope(e.target.value)}
                                className="appearance-none bg-slate-800 text-slate-200 text-sm rounded border border-slate-700 pl-16 pr-10 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none cursor-pointer hover:bg-slate-700 transition-colors w-full"
                            >
                                <option value="global">Entire Record</option>
                                <option value="cards">Cards Only</option>
                                <option value="exalt">Exalts Only</option>
                            </select>
                            <ChevronDown size={14} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none" />
                        </div>
                        </div>

                        {/* Row 2: Standard Filters */}
                        <div className="flex flex-wrap items-center gap-4 pt-4 border-t border-slate-800">
                        <div className="flex items-center gap-2 text-slate-400 mr-2">
                            <Filter size={16} />
                            <span className="text-sm font-semibold uppercase tracking-wide">Filters</span>
                        </div>

                        <div className="flex flex-col sm:flex-row gap-4 flex-grow">
                            <div className="relative">
                            <select
                                value={factionFilter}
                                onChange={(e) => setFactionFilter(e.target.value)}
                                className="appearance-none bg-slate-800 text-slate-200 text-sm rounded border border-slate-700 pl-4 pr-10 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none cursor-pointer hover:bg-slate-700 transition-colors w-full sm:w-40"
                            >
                                {factions.map(f => <option key={f} value={f}>{f === 'All' ? 'All Factions' : f}</option>)}
                            </select>
                            <ChevronDown size={14} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none" />
                            </div>

                            <div className="relative">
                            <select
                                value={typeFilter}
                                onChange={(e) => setTypeFilter(e.target.value)}
                                className="appearance-none bg-slate-800 text-slate-200 text-sm rounded border border-slate-700 pl-4 pr-10 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none cursor-pointer hover:bg-slate-700 transition-colors w-full sm:w-40"
                            >
                                {types.map(t => <option key={t} value={t}>{t === 'All' ? 'All Types' : t}</option>)}
                            </select>
                            <ChevronDown size={14} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none" />
                            </div>

                            {(factionFilter !== 'All' || typeFilter !== 'All' || searchTerm !== '' || sortConfig.key !== null) && (
                            <button 
                                onClick={clearFilters}
                                className="text-xs text-red-400 hover:text-red-300 flex items-center gap-1 px-2 py-2 transition-colors ml-auto sm:ml-0"
                            >
                                <X size={14} />
                                Reset
                            </button>
                            )}
                        </div>
                        </div>
                    </div>
                    </div>

                    {/* Table */}
                    <div className="overflow-hidden rounded-lg border border-slate-700 shadow-xl bg-slate-900">
                    <table className="w-full text-left border-collapse">
                        <thead>
                        <tr className="bg-slate-900 border-b border-slate-700 text-slate-400 text-sm uppercase tracking-wider">
                            <SortableHeader label="Name" sortKey="name" currentSort={sortConfig} onSort={requestSort} />
                            <SortableHeader label="Faction" sortKey="faction" currentSort={sortConfig} onSort={requestSort} />
                            <SortableHeader label="Type" sortKey="type" currentSort={sortConfig} onSort={requestSort} />
                            <SortableHeader label="CON" sortKey="CON" currentSort={sortConfig} onSort={requestSort} />
                            <SortableHeader label="ATK" sortKey="ATK" currentSort={sortConfig} onSort={requestSort} />
                            <SortableHeader label="DEF" sortKey="DEF" currentSort={sortConfig} onSort={requestSort} />
                        </tr>
                        </thead>
                        <tbody>
                        {filteredAndSortedData.length > 0 ? (
                            filteredAndSortedData.map((char) => (
                            <CharacterRow key={char.id} char={char} />
                            ))
                        ) : (
                            <tr>
                            <td colSpan="6" className="p-12 text-center text-slate-500">
                                No entities found matching selected filters.
                            </td>
                            </tr>
                        )}
                        </tbody>
                    </table>
                    </div>
                    
                    <div className="mt-8 text-center text-slate-600 text-xs">
                    Click on any row to expand/collapse details.
                    </div>

                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
